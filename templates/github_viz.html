<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="/static/github_viz.css">
		<!-- <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}"> -->
		<link href='http://fonts.googleapis.com/css?family=Pacifico|Raleway' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Special+Elite|VT323' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/static/iThing.css" type="text/css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
		<script src="/static/Chart.js"></script>
		<script src="/static/jQDateRangeSlider-min.js"></script>
		<script src="/static/jquery-dateFormat.min.js"></script>
		<script src="/static/github_viz.js"></script>
		<title>Github Language Visualization</title>
		<meta name=”description” content=”Github language visualization by Becca Bruggman”>
	</head>


	<body>
		<div class="full_wrapper">			
			<div class="title">Github Language Visualization</div>
			<hr />
			{% if github_viz is mapping %}
				<div class="data_container">
					<div class="wrapper">
						<div class="chart_container">
							<canvas id="myChart" width="400" height="400"></canvas>
						</div>

						<div class="share_container">
							<div>Share your pie</div>
							<div class="icon_container">
								<a href="https://www.facebook.com/sharer/sharer.php?u=http://127.0.0.1:5000/?username={{username}}" target="_blank"><i class="fa fa-facebook"></i> </a>
								<a href="https://twitter.com/home?status=Graph%20of%20all%20my%20coding%20languages%20on%20%40github.%20Sweet!%20http://127.0.0.1:5000/?username={{username}}" target="_blank"><i class="fa fa-twitter"></i></a>
								<a href="https://www.linkedin.com/shareArticle?mini=true&url=http://127.0.0.1:5000/?username={{username}}&title=Check%20out%20the%20languages%20I%20use%20on%20github!&summary=&source=" target="_blank"><i class="fa fa-linkedin"></i></a>
							</div>
						</div>
					</div>
					<div id="slider"></div>

				</div>



				<div class="form_container">
					<form action="/?code={{code}}" method="POST" name="username_submit">
						{% from "_formhelpers.html" import render_field %}
							<div id="submitText"> Want to see someone else? {{form.username(placeholder="Enter username", size="15")}} </div>
							<input type="submit" value="SUBMIT" class="Submit">
					</form>
				</div>

			{% elif github_viz is string %}
				<div class="user_invalid">
					<div class="title"> We can't find that github handle... </div>
					<img class="pusheen" src="http://media.giphy.com/media/ktvFa67wmjDEI/giphy.gif" alt="Sad Pusheen"/>
				</div>
			{% endif %}
		</div>

		<footer>
			<span> Made with <i class="fa fa-heart-o"></i>  by Becca Bruggman </span>
		</footer>
		<script type="text/javascript">

			var total = 0;

			var language_data = [];

			{% if github_viz is mapping %}
				$(".chart_container").after("<div class='languages_container'><div class='user'>{{username}}</div></div>")
				{% for lang, num in github_viz.iteritems() %}
					total+= {{num}}

					language_data.push({
						value: {{num}},
						label: "{{lang}}",
						color: colors[Object.keys(colors)[{{loop.index-1}}]]['color'],
						highlight: colors[Object.keys(colors)[{{loop.index-1}}]]['highlight']

					})

					// need to sort based on num
					$(".languages_container").append('<div data-name={{num}} class="coding_language"> {{lang}} : <span class="lang_num">{{num}}</span><span class="num_hover">{{num}}kb</span></div>')

				{% endfor %}

				var ctx = $("#myChart").get(0).getContext("2d");
				var myPieChart = new Chart(ctx).Pie(language_data,options);
				console.log(myPieChart)

				{% if followers is defined %}
					$(".data_container").after('<div class="title followers_title"> {{username}} is following, see their charts! </div><div class="followers_container"></div>')
					{% for follower in followers %}
						$(".followers_container").append('<div class="follower_name"> <a href="/?username={{follower}}&code={{code}}">{{follower}}</a></div>')

					{% endfor %}
				{% endif %}

				
				format_languages();

				var d = new Date();
				var git_min_date = $.format.date('{{dates}}', 'yyyy, MM, dd');

				$("#slider").dateRangeSlider({
					bounds:{
					    min: new Date(git_min_date),
					    max: new Date(d.getFullYear(), d.getMonth(), d.getDate())
				  	},
				  	defaultValues: {
				  		min: new Date(2008, 3, 10),
					    max: new Date(d.getFullYear(), d.getMonth(), d.getDate())
				  	},
				  	arrows: false,

				});

				$("#slider").bind("userValuesChanged", function(e, slider_data){
				  console.log("Values just changed. min: " + slider_data.values.min + " max: " + slider_data.values.max);
				  	date_min = $.format.date(slider_data.values.min, 'yyyy-MM-dd');
					date_max = $.format.date(slider_data.values.max, 'yyyy-MM-dd');
				  	$.ajax({
						url: "https://api.github.com/users/{{username}}/repos?per_page=1000&client_id={{id}}&client_secret={{secret}}",
						success: function(data) {
							total = 0;
							language_data = [];
							languages_dict = {};
							$(".languages_container").find('.coding_language').remove();
							for (repo in data) {
								var pushed_date = $.format.date(data[repo]['pushed_at'], 'yyyy-MM-dd');
								if (pushed_date > date_min && pushed_date < date_max) {
									if (data[repo]['language'] != null) {
										if (data[repo]['language'] in languages_dict) {
											languages_dict[data[repo]['language']]+= data[repo]['size'];
										}
										else {
											languages_dict[data[repo]['language']]= data[repo]['size'];
										}
										total+= data[repo]['size'];
									}
								}
							}
							var i = 0;
							for (lang in languages_dict) {
								language_data.push({
									value: languages_dict[lang],
									label: lang.toString(),
									color: colors[Object.keys(colors)[i]]['color'],
									highlight: colors[Object.keys(colors)[i]]['highlight']

								})
								i++;

								$(".languages_container").append('<div data-name=' +  languages_dict[lang] + ' class="coding_language"> ' + lang.toString() + ' : <span class="lang_num">' +languages_dict[lang] + '</span><span class="num_hover">' + languages_dict[lang] +'kb</span></div>')
							}
							
							ctx = $("#myChart").get(0).getContext("2d");
							var myPieChart = new Chart(ctx).Pie(language_data,options);
							format_languages();
						}
					});
				});

			{% endif %}
		</script>

	</body>

</html>
